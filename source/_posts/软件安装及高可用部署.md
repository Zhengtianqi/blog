title: 软件安装及高可用部署(一)
author: ztq
tags:
  - 运维
categories:
  - CICD
date: 2022-11-11 11:25:00
---
# 一、硬盘挂载
## （1）查看设备的挂载情况
lsblk或lsblk –f或者fdisk -l
![img](/img/bushu1.png)
![img](/img/bushu2.png)
## （2）分区
fdisk /dev/vdb   其中/dev/vdb表示上图未挂载的硬盘
分区步骤如下图，下图以/dev/sdb为例
![img](/img/bushu3.png)
![img](/img/bushu4.png)
![img](/img/bushu5.png)
## （3）格式化
```java
mkfs -t ext4 /dev/vdb1   其中/dev/vdb1是要格式化的分区名，下图以/dev/sdb1为例
```
![img](/img/bushu6.png)
## （4）挂载
```java
挂载到/mnt目录下，具体操作步骤如下：
进入 mmt目录
cd /mmt/
挂载到 /mnt
mount /dev/vdb1 /mnt   其中/dev/vdb1是要挂载的分区名
```
## （5）设置可以自动挂载（永久挂载，当你重启 Linux 之后，仍然可以挂载）
```java
永久挂载：通过修改 /etc/fstab 实现挂载
vim  /etc/fstab打开/etc/fstab文件，如下图所示，添加下一行内容，其中，/dev/vdb1  /mnt是要挂载内容。
```
![img](/img/bushu7.png)
## （6）查看
```java
df –h
```
![img](/img/bushu8.png)

# 二、JDK 1.8安装
## （1）官网下载需要安装版本jdk，下载地址
https://www.oracle.com/java/technologies/javase/javase-jdk8-downloads.html
![img](/img/bushu9.png)

## （2）拷贝至linux安装目录
```java
将下载好的jdk包拷贝至/usr/local/java 目录下
进入目录：
cd /usr/local/java
解压：
tar zxvf jdk-8u351-linux-x64.tar.gz
```
## （3）配置环境变量
```java
编辑/etc/profile文件
vim /etc/profile

编辑模式在文档中增加如下行：
export JAVA_HOME=/usr/local/java/jdk1.8.0_351
export CLASSPATH=.:$JAVA_HOME/jre/lib/rt.jar:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar
export PATH=$PATH:$JAVA_HOME/bin

生效环境变量
source /etc/profile
```
## （4）验证是否安装成功
```java
java -version
```
![img](/img/bushu11.png)

# 三、MYSQL安装
## （1）卸载mariadb
```java
# 查看 mariadb 的安装包
rpm -qa | grep mariadb
# 卸载 mariadb 的安装包
rpm -e mariadb-libs-5.5.68-1.el7.x86_64 --nodeps
# 再次查看
rpm -qa | grep mariadb
```
## （1）添加mysql组和用户
```java
groupadd mysql
useradd -r -g mysql mysql
```
## （2）安装mysql
### 安装源
```java
更新yum
yum update –y
安装wget工具
创建安装目录
mkdir -p /usr/local/mysql
然后进入安装目录
cd /usr/local/mysql
再执行
sudo yum install -y wget
使用wget下载mysql yum源
wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
添加 mysql yum 源
sudo yum localinstall mysql80-community-release-el7-3.noarch.rpm –y
安装 yum 工具 yum-utils
sudo yum install -y yum-utils
```
### MySQL安装版本选择
```java
查看可用的 mysql
yum repolist enabled | grep "mysql.*-community.*"
查看所有的 mysql 版本
yum repolist all | grep mysql
使用执行版本的mysql
目前是8.0的版本，假如系统要使用MySQL5.7，那么需要先关闭MySQL8.0
关闭MySQL8.0
sudo yum-config-manager --disable mysql80-community
开启MySQL5.7
sudo yum-config-manager --enable mysql57-community
查看当前启用的MySQL版本
yum repolist enabled | grep mysql
```
### MySQL安装
```java
安装MySQL
sudo yum install -y mysql-community-server
```
![img](/img/bushu12.png)
```java
如果上面语句执行出现上图所示报错，就执行
yum install mysql-community-server --nogpgcheck
```
## （3）配置文件
```java
vim /etc/my.cnf
# 将原配置文件内容清空，添加以下配置内容↓：
[client]
port=3306
socket=/mysql/run/mysql/mysql.sock
default-character-set=utf8mb4
[mysqld]
user=mysql
# 注意! 如果是mysql-backup服务器，需要将server-id的值修改为2
server-id=1
port=3306
mysqlx_port=33060
mysqlx_socket=/mysql/run/mysql/mysqlx.sock
basedir=/mysql
datadir=/mysql/data
配置系统服务
socket=/mysql/run/mysql/mysql.sock
pid-file=/mysql/run/mysql/mysqld.pid
log-error=/mysql/logs/error.log
log-bin=/mysql/logs/bin.log
relay-log=/mysql/logs/relay.log
binlog_format=ROW
relay_log_recovery=1
character-set-client-handshake=FALSE
character-set-server=utf8mb4
collation-server=utf8mb4_unicode_ci
init_connect ='SET NAMES utf8mb4'
innodb_buffer_pool_size=1G
join_buffer_size=128M
sort_buffer_size=2M
read_rnd_buffer_size=2M
log_timestamps = SYSTEM
lower_case_table_names = 1
default-authentication-plugin=mysql_native_password
#skip-grant-tables
```
## （4）配置系统服务
```java
cd /mysql/
# 创建data和logs目录
mkdir data
mkdir logs
# 创建mysql运行目录
mkdir -p /mysql/run/mysql/
# 修改文件夹用户归属
chown -R mysql:mysql /mysql/run/mysql/
chown -R mysql:mysql /mysql
chmod 777 /mysql/run/mysql
chmod 775 /mysql -R
# link
ln -s /mysql/bin/mysql /usr/local/bin
ln -s /mysql/bin/mysqld /usr/local/bin
# 初始化
mysqld --initialize --console
# 获取密码
cat logs/error.log |grep password
# 添加mysql到服务中
cp support-files/mysql.server /etc/init.d/mysql
# 设置安装目录和data目录
vim /etc/init.d/mysql
# 修改如下内容，大概在46行左右位置
basedir=/mysql
datadir=/mysql/data
MySQL配置
在mysql-backup服务器上重复以上步骤，安装MySQL。
# 目录赋权
chmod -R 777 /mysql/run/mysql
chown -R mysql:mysql /mysql/run/mysql/
# 加载
systemctl daemon-reload
# 启动
systemctl start mysql
# 查看运行状态
systemctl status mysql
# 开机启动
systemctl enable mysql
```
### 默认路径的密码（未修改配置文件）
```java
查看初始化密码：
sudo grep 'temporary password' /var/log/mysqld.log
```
## （5）配置MySQL服务
```java
# 登录mysql
mysql -p -S /mysql/run/mysql/mysql.sock
# 修改root账户密码
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY
'**********';
# 退出使用新密码登录
exit;
# 重新登录
mysql -u root -p
# 创建远程操作账户，进行远程访问的授权
create user 'root'@'%' identified with mysql_native_password by '**********';
grant all privileges on *.* to 'root'@'%' with grant option;
flush privileges;
# 退出登录
exit;
```
在mysql-backup服务器上重复以上步骤，安装MySQL。
## （6）MySQL主从同步配置
### 登录mysql-master服务器，主库修改配置文件 vim /etc/my.cnf 。
```java
vim /etc/my.cnf
# 在[mysqld]下面修改或增加配置：
server-id=1
log-bin=master-bin
log-bin-index=master-bin.index
# 保存配置后，重启主库mysql服务
systemctl restart mysql
```
### 登录mysql-master服务器，先进入主库，进行锁表，防止数据写入。
```java
mysql -uroot -p
mysql> flush tables with read lock;
mysql> exit;
```
### 登录mysql-backup服务器，修改从库数据库配置文件。
```java
vim /etc/my.cnf
# 在[mysqld]下面修改或增加配置：
server-id=2
# 保存配置后，重启从库mysql服务
systemctl restart mysql
```
### 登录mysql-master服务器，导出数据。
```java
# 导出数据库
cd /tmp
/mysql/bin/mysqldump -uroot -p --master-data=1 --single-transaction --routines --triggers --events --all-databases > all.sql
```
### 登录mysql-backup服务器，导入数据。
```java
# 将导出的数据all.sql，上传到从库服务器
cd /tmp
# 在文件上传的位置，登录数据库进行数据导入
mysql -uroot -p
mysql> source all.sql;
```
### 登录mysql-master服务器，登录数据库查看主库同步信息。
```java
mysql> SHOW MASTER STATUS;
+-------------------+----------+--------------+------------------+--------------
-----+
| File | Position | Binlog_Do_DB | Binlog_Ignore_DB |
Executed_Gtid_Set |
+-------------------+----------+--------------+------------------+--------------
-----+
| master-bin.000005 | 155 | | |
|
+-------------------+----------+--------------+------------------+--------------
-----+
1 row in set (0.00 sec)
```
### 登录mysql-backup服务器，登录数据库配置同步信息。
```java
stop slave;
change master to master_auto_position=0;
# 将MASTER_HOST、MASTER_LOG_FILE和MASTER_LOG_POS参数替换为实际的配置
CHANGE MASTER TO MASTER_HOST='主库IP地
址',MASTER_USER='root',MASTER_PASSWORD='2wsx@WSX',MASTER_LOG_FILE='masterbin.000005',MASTER_LOG_POS=155;
start slave;
show slave status \G;
```
### 登录mysql-master服务器，解除锁表。
```java
unlock tables;
```
# 四、redis安装
## （1）下载
官网下载需要安装版本redis，下载地址
https://redis.io/download
http://download.redis.io/releases/  (所有版本)
```java
解压
tar -zxvf redis-7.0.5.tar.gz
cd redis-7.0.5/
```
## （2）编译源码
```java
make
make PREFIX=/redis install
```
## （3）复制配置文件
```java
cp /usr/local/redis/redis-7.0.5/redis.conf /redis/
```
## （4）创建日志文件
```java
mkdir /redis/logs
touch /redis/logs/redis.log
chmod 666 /redis/logs/redis.log
mkdir /redis/aof/
chmod 777 /redis/aof/
```
## （5）修改配置文件
```java
vim /redis/redis.conf
# 找到bind配置，添加注释（69行）
#bind 127.0.0.1
# 找到daemonize，将配置修改为yes（136行）
daemonize yes
# 取消保护模式（88行）
protected-mode no
# 增加密码
requirepass ************
# 配置文件路径（171行）
logfile "/redis/logs/redis.log"
# 配置文件路径（263行）
dir /redis/aof/
注册系统服务
重载系统服务
添加自启
防火墙配置
将防火墙服务停止并禁止开机自启。
在redis-backup服务器上重复以上步骤，安装Redis。
# 配置文件路径（699行）
appendonly no
# 配置文件路径，取消注释（216行）
save ""
# 配置文件路径，添加注释（218-220行）
# save 900 1
# save 300 10
# save 60 10000
# 配置文件路径（806行）
aof-use-rdb-preamble no
```
## （6）注册系统服务
### 修改启动文件
```java
vim /usr/lib/systemd/system/redis.service
# 添加以下内容，保存退出
[Unit]
Description=Redis
After=syslog.target network.target remote-fs.target nss-lookup.target
[Service]
Type=forking
PIDFile=/var/run/redis_6379.pid
ExecStart=/redis/bin/redis-server /redis/redis.conf
ExecReload=/bin/kill -s HUP $MAINPID
ExecStop=/bin/kill -s QUIT $MAINPID
PrivateTmp=true
[Install]
WantedBy=multi-user.target
```
### 重载系统服务
```java
systemctl daemon-reload
```
### 添加自启
```java
systemctl start redis
systemctl status redis
systemctl enable redis
```
在redis-backup服务器上重复以上步骤，安装Redis。
## （7）高可用配置（主从）
编辑redis-backup服务器上redis配置文件。
```java
vim /redis/redis.conf
# 编辑从库的redis.conf配置文件，搜索replicaof（286行），去掉注释，修改为：
replicaof 主库IP 6379
# 从库重启redis
systemctl restart redis
# 主库使用客户端：redis-cli，添加键值
cd /redis/bin/
./redis-cli
127.0.0.1:6379> SET runoobkey redis
# 从库使用客户端：redis-cli，查看是否同步了主库的数据
cd /redis/bin/
./redis-cli
127.0.0.1:6379> keys *
1) "runoobkey"
```
